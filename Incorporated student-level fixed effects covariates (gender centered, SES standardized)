import pymc as pm
import numpy as np
import pandas as pd
import arviz as az

# Example data setup (replace with actual loading)
# df = pd.read_csv('pirls_data.csv')
# Required columns: 'y' (score), 'country_idx', 'school_idx', 'class_idx'
# Student-level covariates (examples):
# 'gender' (0=male, 1=female, or coded as -0.5/0.5 for centering)
# 'ses' (standardized socio-economic status index, mean=0, sd=1)

# Ensure covariates are in df and properly centered/standardized
# Example preprocessing:
df['gender_centered'] = df['gender'] - df['gender'].mean()  # or -0.5/0.5 coding
df['ses_standardized'] = (df['ses'] - df['ses'].mean()) / df['ses'].std()

# Coordinates
countries = np.unique(df['country_idx'])
schools = np.unique(df['school_idx'])
classes = np.unique(df['class_idx'])

coords = {
    "country": countries,
    "school": schools,
    "class": classes,
    "obs": np.arange(len(df))
}

with pm.Model(coords=coords) as pirls_four_level_student_covariates_pymc:
    # Hyperpriors
    mu_global = pm.Normal("mu_global", mu=500, sigma=100)
    
    tau_country = pm.HalfCauchy("tau_country", beta=60)
    tau_school = pm.HalfCauchy("tau_school", beta=45)
    tau_class = pm.HalfCauchy("tau_class", beta=35)
    
    sigma_obs = pm.HalfNormal("sigma_obs", sigma=70)
    
    # Non-centered random effects
    z_country = pm.Normal("z_country", mu=0, sigma=1, dims="country")
    z_school = pm.Normal("z_school", mu=0, sigma=1, dims="school")
    z_class = pm.Normal("z_class", mu=0, sigma=1, dims="class")
    
    # Hierarchical means (group-level)
    mu_country = pm.Deterministic("mu_country", mu_global + z_country * tau_country, dims="country")
    
    mu_school = pm.Deterministic(
        "mu_school",
        mu_country[df['country_idx'].values] + z_school[df['school_idx'].values] * tau_school,
        dims="obs"
    )
    
    mu_class = pm.Deterministic(
        "mu_class",
        mu_school + z_class[df['class_idx'].values] * tau_class,
        dims="obs"
    )
    
    # Student-level covariates (fixed effects slopes)
    beta_gender = pm.Normal("beta_gender", mu=0, sigma=20)   # Effect of gender (centered)
    beta_ses = pm.Normal("beta_ses", mu=20, sigma=20)        # Positive prior expectation for SES
    
    # Student-level predicted mean with covariates
    mu_student = pm.Deterministic(
        "mu_student",
        mu_class 
        + beta_gender * df['gender_centered'].values
        + beta_ses * df['ses_standardized'].values,
        dims="obs"
    )
    
    # Likelihood
    y_obs = pm.Normal(
        "y_obs",
        mu=mu_student,
        sigma=sigma_obs,
        observed=df['y'].values,
        dims="obs"
    )
    
    # Sampling
    trace = pm.sample(1000, tune=1000, target_accept=0.95, random_seed=42)

# Posterior Predictive Checks
with pirls_four_level_student_covariates_pymc:
    ppc = pm.sample_posterior_predictive(
        trace,
        var_names=["y_obs"],
        extend_inferencedata=True,
        random_seed=42
    )

# LOOCV Validation (PSIS-LOO)
loo = az.loo(trace, pointwise=True)
print(loo)

# Visualization Examples
az.plot_ppc(trace)
az.plot_forest(trace, var_names=["beta_gender", "beta_ses", "mu_global"])
