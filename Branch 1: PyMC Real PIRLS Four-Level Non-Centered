import pymc as pm
import arviz as az
import numpy as np

with pm.Model() as pirls_four_level:
    # Hyperpriors (PIRLS scaled ~500 mean, 100 sd)
    mu_global = pm.Normal("mu_global", mu=500, sigma=100)
    tau_country = pm.HalfCauchy("tau_country", beta=60)
    tau_school = pm.HalfCauchy("tau_school", beta=45)
    tau_class = pm.HalfCauchy("tau_class", beta=35)

    # Country level non-centered
    country_offset = pm.Normal("country_offset", 0, 1, shape=n_countries)
    mu_country = pm.Deterministic("mu_country", mu_global + country_offset * tau_country)

    # School level non-centered
    school_offset = pm.Normal("school_offset", 0, 1, shape=n_schools)
    mu_school = pm.Deterministic("mu_school", mu_country[country_idx] + school_offset[school_idx] * tau_school)

    # Class level non-centered
    class_offset = pm.Normal("class_offset", 0, 1, shape=n_classes)
    mu_class = pm.Deterministic("mu_class", mu_school[school_idx] + class_offset[class_idx] * tau_class)

    # Likelihood
    sigma_obs = pm.HalfNormal("sigma_obs", sigma=70)
    obs = pm.Normal("obs", mu=mu_class, sigma=sigma_obs, observed=y)

    trace = pm.sample(1000, tune=1500, target_accept=0.95)

print(az.summary(trace, var_names=["mu_global", "tau_country", "tau_school", "tau_class"]))
